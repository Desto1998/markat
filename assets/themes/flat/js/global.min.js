$.fn.appFormValidator.internal_options.on_required_add_symbol = false;

$(function () {

    // Fix for dropdown in tables
    $('body').on('shown.bs.dropdown', '.btn-group', function () {
        $(this).closest('.table-responsive').css("overflow", "inherit");
    });

    $('body').on('hidden.bs.dropdown', '.btn-group', function () {
        $(this).closest('.table-responsive').css("overflow", "auto");
    });

    appSelectPicker($('body').find('select'));
    appProgressBar();
    appLightbox();
    appColorPicker();
    appDatepicker();

    // Lightbox for knowledge base images
    $.each($('.kb-article').find('img'), function () {
        $(this).wrap('<a href="' + $(this).attr('src') + '" data-lightbox="kb-attachment"></a>');
    });

    $('body').tooltip({
        selector: '[data-toggle="tooltip"]'
    });


    // Bootstrap switch active or inactive global function
    $("body").on('change', '.onoffswitch input', function (event, state) {
        var switch_url = $(this).data('switch-url');
        if (!switch_url) {
            return;
        }
        switch_field(this);
    });

    $('.close-edit-menu-modal').click(function (e) {
        e.preventDefault();
        $('#modal-edit-menu').modal('hide');
    })

    $('#edit-menu').click(function (e) {
        e.preventDefault();

        $('#modal-edit-menu #name').val($(this).parent().find('span').html().trim());
        $('#modal-edit-menu').modal('show');
    })

    $('#newoccupation').on('change', '.startdate, .enddate', function (event) {
        var a = $(this).parents('#newoccupation').find('.startdate').val(),
            b = $(this).parents('#newoccupation').find('.enddate').val();
        if (a != '' && b != '') {

            requestGet('belegungsplan/load_free_aq/'+a+'/'+b).done(function (response) {
                response = JSON.parse(response);
                $('#newoccupation #wohnungen').empty();
                $('#newoccupation #wohnungen').html(response);
                $('#newoccupation #wohnungen').selectpicker('refresh');

            });
            a = moment(a, "DD.MM.YYYY");
            b = moment(b, "DD.MM.YYYY");
            zze = b.diff(a, 'days');
            ausstehend = b.diff(moment(), 'days');
            !isNaN(zze) && zze > 0 ? zze : 0
            $(this).parents('#newoccupation').find('.ausstehend').val(ausstehend);
            $(this).parents('#newoccupation').find('.resttage').val(zze);
        } else {
            $(this).parents('#newoccupation').find('.resttage').val(0);
            $(this).parents('#newoccupation').find('.ausstehend').val(0);
        }

    });



// Switch field make request
    function switch_field(field) {
        var status, url, id;
        status = 0;
        if ($(field).prop('checked') === true) {
            status = 1;
        }
        url = $(field).data('switch-url');
        id = $(field).data('id');
        requestGet(url + '/' + id + '/' + status);
    }


// General helper function for $.get ajax requests
    function requestGet(uri, params) {
        params = typeof (params) == 'undefined' ? {} : params;
        var options = {
            type: 'GET',
            url: uri.indexOf(admin_url) > -1 ? uri : admin_url + uri
        };
        return $.ajax($.extend({}, options, params));
    }


    // Init popovers
    $('body').popover({
        selector: '[data-toggle="popover"]'
    });

    $('.article_useful_buttons button').on('click', function (e) {
        e.preventDefault();
        var data = {};
        data.answer = $(this).data('answer');
        data.articleid = $('input[name="articleid"]').val();
        $.post(site_url + 'knowledge_base/add_kb_answer', data).done(function (response) {
            response = JSON.parse(response);
            if (response.success == true) {
                $(this).focusout();
            }
            $('.answer_response').html(response.message);
        });
    });

    $('#identityConfirmationForm').appFormValidator({
        rules: {
            acceptance_firstname: 'required',
            acceptance_lastname: 'required',
            signature: 'required',
            acceptance_email: {
                email: true,
                required: true
            }
        },
        messages: {
            signature: {
                required: app.lang.sign_document_validation,
            },
        },
    });

    if ($('.field-cloneb').length > 0) {
        f();
        $('#wohnungen').on("keyup keypress click  blur change", ".enddate, .startdate", function (e) {
            f();
        });

        function f() {
            $('.field-cloneb').each(function (i, obj) {
                var a = $(this).find('.startdate').val(),
                    b = $(this).find('.enddate').val();
                if (a != '' && b != '') {
                    a = moment(a, "DD.MM.YYYY");
                    b = moment(b, "DD.MM.YYYY");
                    zze = b.diff(a, 'days');
                    ausstehend = b.diff(moment(), 'days');
                    !isNaN(zze) && zze > 0 ? zze : 0
                    $(this).find('.ausstehend').val(ausstehend);
                    $(this).find('.resttage').val(zze);
                } else {
                    $(this).find('.resttage').val('0');
                    $(this).find('.ausstehend').val('0');
                }
            });
        }
    }


    if ($('#tt-pop').length > 0) {
        $('#add-div a').click(function (e) {
            e.preventDefault();
            $cloned = $('.field-clone:last').clone();
            $cloned.selectpicker('refresh');
            $cloned.find('.dropdown-toggle').remove();
            $cloned.insertBefore('#add-div');
            $('.field-clone').each(function (i, obj) {
                $(this).find('.count-k').html(i + 1);
            });
            init_selectpicker();
        });

        $('#add-divb a').click(function (e) {
            e.preventDefault();
            $cloned = $('.field-cloneb:last').clone();
            $cloned.insertBefore($('#add-divb').parent());
            $cloned.find('.dropdown-toggle').remove();
            init_datepicker();
            init_selectpicker();

        });
    }


    $('body.identity-confirmation #accept_action').on('click', function () {
        var $submitForm = $('#identityConfirmationForm');
        if ($submitForm.length && !$submitForm.validate().checkForm()) {
            $('#identityConfirmationModal').modal({show: true, backdrop: 'static', keyboard: false});
        } else {
            $(this).prop('disabled', true);
            $submitForm.submit();
        }
        return false;
    });
});

function createDropzone(elementId, options) {
    var defaults = appCreateDropzoneOptions({
        paramName: "file",
        uploadMultiple: true,
        parallelUploads: 20,
        maxFiles: 20,
        accept: function (file, done) {
            done();
        },
        success: function (file, response) {
            if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                window.location.reload();
            }
        },
    });

    var settings = $.extend({}, defaults, options);
    new Dropzone(elementId, settings);
}
